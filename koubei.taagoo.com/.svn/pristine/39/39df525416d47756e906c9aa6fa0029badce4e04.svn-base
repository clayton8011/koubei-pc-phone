<?php

namespace common\models;

use common\models\Common;
use Yii;

/**
 * This is the model class for table "{{%panoramic_material}}".
 *
 * @property integer $id
 * @property integer $member_id
 * @property string $title
 * @property string $width
 * @property string $height
 * @property string $size
 * @property string $scene_str
 * @property string $image_str
 * @property string $tilesize
 * @property string $img_level_size
 * @property integer $status
 * @property integer $created_at
 * @property integer $remote_path
 */
class PanoramicMaterial extends \yii\db\ActiveRecord
{
    public $file_verification;
    /**
     * @inheritdoc
     */
    public static function tableName()
    {
        return '{{%panoramic_material}}';
    }

    /**
     * @inheritdoc
     */
    public function rules()
    {
        return [

        ];
    }

    /**
     * @inheritdoc
     */
    public function attributeLabels()
    {
        return [
            'id' => 'ID',
            'member_id' => '所属用户',
            'title' => '标题',
            'status' => '状态',
            'created_at' => '创建日期',
            'width' => '宽',
            'height' => '高',
            'size'=>'大小',
            'remote_path' => 'oss路径',
            'tilesize'=>'切图尺寸',
            'img_level_size'=>'切图级别尺寸',
            'scene_str'=>'场景字符串',
            'image_str'=>'场景image字符串'
        ];
    }

    public function beforeValidate()
    {
        if($this->scenario!='default' && $this->scenario!='search'){
            if ($this->isNewRecord) {
                $this->created_at = time();
            }
        }
        return parent::beforeValidate();
    }

    /**
     * 场景设置
     * @return  {[type]} [description]
     * @version 1.0      2015-12-31T15:48:46+0800
     * @author cnzhangxl@foxmail.com
     */
    public function scenarios()
    {
        return [
            'create' => ['member_id','title','status','created_at','width','height','size','remote_path','tilesize','img_level_size','scene_str','image_str',],
            'update' => ['member_id','title','status','created_at','width','height','size','remote_path','tilesize','img_level_size','scene_str','image_str',]
        ];
    }

    public function formName()
    {
        if (Yii::$app->request->post('appKey')){
            return '';
        }else{
            return parent::formName(); // TODO: Change the autogenerated stub
        }

    }

    /**
     * 获取数据
     * @date   2016-03-25T17:10:24+0800
     * @author cnzhangxl@foxmail.com
     * @return [type]                   [description]
     */
    public static function getCacheInfo($id){
        return self::findOne($id);
    }

    /**
     * 获取用户信息
     * @date   2016-03-24T10:53:02+0800
     * @author cnzhangxl@foxmail.com
     * @return [type]                   [description]
     */
    public function getMember(){
        return $this->hasOne('common\models\Member', ['id' => 'member_id']);
    }

     /**
     * 调用切图服务
     * @date   2016-11-02T11:21:33+0800
     * @author cnzhangxl@foxmail.com
     * platform_id平台id  scene_ids_arr场景对应的id files_path_arr 场景对应id的文件路径 scene_id=>value
     */
    public function cutSceneService($platform_id,$scene_ids_arr,$files_path_arr){
        $returnArr = ['status'=>0,'msg'=>''];
        $data = array(
            'platform_id'=>$platform_id?$platform_id:2,//平台id
            'scene_ids'=>implode(',',$scene_ids_arr),//平台对应场景的id
            // 'scene_2' => curl_file_create('/Users/cnzhangxl/Downloads/star_hei.png','image/png','star_hei')
        );
        foreach ($files_path_arr as $key => $value) {
            $data['scene_'.$key] = curl_file_create($value,'image/jpeg','scene.jpg');
        }
        $res = Common::reqUrl(Yii::$app->params['panoramic_upload_url'],$data,false,0);
        if($res && $res['content']){
            $jsonArr = json_decode($res['content'],true);
            if($jsonArr['status']==1){
                $returnArr['status'] = 1;
            }
        }
        return $returnArr;
    }


    /**
     * 调用切图服务2
     * @date   2016-11-02T11:21:33+0800
     * @author cnzhangxl@foxmail.com
     * platform_id平台id  scene_ids_arr场景对应的id files_path_arr 场景对应id的文件路径 scene_id=>value
     */
    public function cutSceneService2($platform_id,$panoramic_material_id,$file_path){
        $res = [];
        $res['status'] = false;
        //同步客户端
        $client = new \swoole_client(SWOOLE_SOCK_TCP);
        //连接到服务器
        $cutServiceParam = Yii::$app->params['cut_service'];
        if ($client->connect($cutServiceParam['ip'], $cutServiceParam['port'], $cutServiceParam['timeout'])){
            //向服务器发送数据
            $sendData = [
                'cmd'=>'cutpano',
                'data'=>[
                    'platform_id'=>$platform_id?$platform_id:3,
                    'panorama_id'=>$panoramic_material_id,
                    'file_path'=>$file_path
                ]
            ];
            if ($client->send(json_encode($sendData))){
                //从服务器接收数据
                $data = $client->recv();
                if ($data=='ok'){
                    $res['status'] = true;
                }
                //关闭连接
                $client->close();
            }
        }
        return $res;
    }


    /**
     * 获取状态码
     * @return  [type] [description]
     * @version 1.0    2015-12-31T16:52:39+0800
     * @author zhangxianglong@yolo24.com
     */
    public static function getStatus()
    {
        return [
            '' => '请选择',
            1 => '正常',
            2 => '删除',
            3 => '待审核',
            4 => '审核未通过',
            5 =>'待发布',
            6 =>'切图失败',
            7 =>'待切图'
        ];
    }

    /**
     * 获取图片的前缀地址
     * @date   2016-07-03T10:16:44+0800
     * @author cnzhangxl@foxmail.com
     * @param  [type]                   $model [description]
     * @return [type]                          [description]
     */
    public function getPicPreview(){
        return Common::getPanoDomain($this->id).$this->remote_path.'/';
    }

    /**
     * 获场景图缩小尺寸
     * @date   2016-11-08T17:29:02+0800
     * @author cnzhangxl@foxmail.com
     * @return [type]                   [description]
     */
    public function getOriginalThumbs(){
        $arr['default'] = Common::getPanoDomain($this->id).$this->remote_path.'/'.'small.jpg';
        return $arr;
    }


    /**
     * 获场景缩略图
     * @date   2016-11-08T17:29:02+0800
     * @author cnzhangxl@foxmail.com
     * @return [type]                   [description]
     */
    public function getThumbs(){
        $arr['default'] = Common::getPanoDomain($this->id).$this->remote_path.'/'.'thumb.jpg';
        if(!in_array($this->status,[1,3])){
            $arr['default'] = '/images/cutting.png';
        }
        return $arr;
    }

    /**
     * 获场景缩略图2  与上次版本上次图片方式不一样
     * 上次版本 路径 /uploads/201607/13/5785f275b54cb.jpg
     * 替换后应该   Yii::$app->params['www_domain']  +  /uploads/201607/13/5785f275b54cb.jpg
     */
    static function replaceThumbs($picUrl)
    {
        if (!strstr($picUrl, "http")) {
            $picUrl = Yii::$app->params['www_domain'] . $picUrl;
        }
        return $picUrl;
    }

    /**
     * 获取scene的值
     * @date   2016-09-08T11:11:14+0800
     * @author cnzhangxl@foxmail.com
     * @param  [type]                   $model [description]
     * @return [type]                          [description]
     */
    public function getSceneContent($picPreview){
        $str = '';
        if(!$this->image_str){
            if($this->tilesize){
                $arr = json_decode($this->img_level_size,true);
                if($arr){
                    $str .= '<image type="CUBE" multires="true" tilesize="'.$this->tilesize.'" if="!webvr.isenabled">';
                    foreach($arr as $row){
                        $str.='<level tiledimagewidth="'.$row[1].'" tiledimageheight="'.$row[2].'">
                                    <cube url="'.$picPreview.(isset($row['url_str'])?$row['url_str']:('l'.$row[0].'_%s_%v_%h.jpg')).'" />
                                </level>';
                    }
                    $str .='</image>';
                }
            }
            if(!$str){
                $str.='<image>
                            <cube url="'.$picPreview.'pano_%s.jpg"></cube>
                            <mobile>
                                <cube url="'.$picPreview.'mobile_%s.jpg"></cube>
                            </mobile>
                        </image>';
            }
        }else{
            $str .= str_replace('url="','url="'.$picPreview,$this->image_str);
        }
        return $str;
    }
    
    /**
     * 添加场景图
     * @param $data object 动景数据
     * @return mixed
     */
    public static function addMaterial($data)
    {
        $materialModel = new self();
        $materialModel->scenario = 'create';
        $materialModel->title = $data->post('file_title');
        $materialModel->height = $data->post('height');
        $materialModel->size = $data->post('size');
        $materialModel->width = $data->post('width');
        $materialModel->status = 7;
        $materialModel->member_id = Yii::$app->user->id;
        $materialModel->remote_path = $data->post('filename');
        if($materialModel->save()){
            //$cutRes = $materialModel->cutSceneService2('', $materialModel->id, $materialModel->remote_path);
            //if ($cutRes['status'] == true) {
                //如果包含场景图,需要统计场景图相关联的动景进度，以及此场景的进度
                //Yii::$app->redis->hset('vr_cloud_cut_pano_notify:panoramic_material', $materialModel->id, 1);
                return $materialModel;
            //}
        }else{
            Yii::error($materialModel);
        }
        return false;
    }
}
